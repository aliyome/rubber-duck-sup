# Tasks

- [x] AI ツールに対し「Cloudflare Workers 上で動作する Discord bot の基本的な仕組みを、メッセージの送受信方法と定期実行のトリガー方法を含めて、サンプルコード付きで説明してください」と依頼し、プロジェクト用の技術メモを作成する
  - [discord_bot_on_cloudflare_workers.md](research/discord_bot_on_cloudflare_workers.md)
- [-] AI ツールに対し「Cloudflare Workers 上で利用可能な Discord bot 開発用フレームワークまたはライブラリを 3 つ挙げ、それぞれの長所・短所を比較した上で、今回の要件に最適なものを提案してください」と依頼し、使用するフレームワークを選定する
  - 今回は Hono を採用する
- [x] Cloudflare Workers AI の公式ドキュメントを確認し、テキスト生成モデルと要約モデルの API 仕様（リクエスト形式、レスポンス形式、利用可能なモデル）を調査し、結果をまとめる
  - [cloudflare_ai.md](research/cloudflare_ai.md)
- [x] Cloudflare Workers で状態を永続化する方法として、Cloudflare KV と D1 の特性を調査し、会話コンテキストの保存に適した技術を選定する
  - [kv_or_d1.md](research/kv_or_d1.md)
- [x] 選定した技術スタック（Discord bot フレームワーク、DB）に基づき、プロジェクト全体の処理フローとデータモデル（ユーザー ID、会話履歴、タイムスタンプ等）を設計し、シーケンス図を含む簡単な図や文章で書き出す
  - [processing_flow_and_data_model.md](research/processing_flow_and_data_model.md)
- [x] テストフレームワークとして Vitest を選定し、Discord API と Cloudflare Workers AI の応答をモック化するテスト方針を決定する
  - [test_plan_with_vitest.md](research/test_plan_with_vitest.md)
- [x] Cloudflare のダッシュボードから`wrangler` CLI をインストールし、`wrangler init`コマンドで新規プロジェクトを作成する
- [x] Discord Developer Portal で新規アプリケーションを作成し、Bot のトークン、Application ID、公開鍵を取得する
- [x] `wrangler.jsonc`ファイルに必要な設定を記述し、取得したトークン類を`wrangler secret put`コマンドで Cloudflare Workers のシークレットとして登録する
- [x] 開発用の Discord サーバーを作成し、開発中の bot をそのサーバーに招待する
- [x] Vitest をプロジェクトにセットアップ
- [x] Discord からの Webhook リクエストと Cloudflare Workers AI の API レスポンスを模倣するモックデータを作成する
  - [test/fixtures/index.ts](../test/fixtures/index.ts)
- [x] Discord からの Webhook リクエストの署名を検証するロジックの単体テストを、正常系（有効な署名）と異常系（無効な署名）の観点で実装する
  - [test/verify-discord-signature.spec.ts](../test/verify-discord-signature.spec.ts)
- [x] AI ツールに「wrangler と TypeScript を使い、Discord からの ping-pong リクエストに応答する Cloudflare Workers の最小限のコード例を生成してください」と依頼し、bot の疎通確認用エンドポイントを実装する
  - `src/hono.ts` に PING→PONG 応答処理を追加し、Discord Dashboard で疎通確認済み
- [x] Cron Triggers を設定し、最新設計に沿って毎分発火する定期実行の雛形を実装する
  - `wrangler.jsonc` に毎分の `crons` を追加 (`triggers.crons = ["* * * * *"]`)
  - `src/index.ts` に `scheduled` ハンドラを実装し、`src/jobs/promptScheduler.ts` のエントリポイントへ委譲
  - D1 で扱うセッション／メッセージ行の型とリポジトリ雛形を `src/data/` 配下に追加
- [x] ユーザー ID をキーとして、会話の履歴を Cloudflare KV（または D1）に保存する関数を実装する
  - `src/data/conversationRepository.ts` に `saveConversationMessage` を追加
- [x] ユーザー ID をキーとして、保存された会話の履歴を Cloudflare KV（または D1）から取得する関数を実装する
  - `src/data/conversationRepository.ts` に `getConversationHistoryForUser` を追加
- [x] AI ツールに「以前の会話履歴のテキストをコンテキストとして渡し、『{前回の作業内容}という状態でしたが、現在の進捗はどうですか？』のような自然な問いかけ文を生成する Cloudflare Workers AI への API リクエストのコード例を生成してください」と依頼し、進捗確認メッセージを動的に生成する機能を実装する
- [x] Cron Triggers によって起動され、対象ユーザーの会話履歴を取得し、動的に生成した進捗確認メッセージを Discord に送信する機能を実装する
  - `src/jobs/promptScheduler.ts` が `src/lib/ai/progressPrompt.ts` と `src/lib/discord/api.ts` を利用してスレッドへ投稿
  - `test/promptScheduler.spec.ts` でスケジューラの動作を確認
- [x] ユーザーからの進捗報告メッセージを受け取り、その内容を会話履歴として保存する機能を実装する
  - `/interactions` の `progress` コマンドを `src/lib/discord/interactions/progress.ts` で処理し、D1 に保存
  - `test/progressInteraction.spec.ts` で保存処理とスケジュール更新を検証
- [x] AI ツールに「ユーザーからの進捗報告テキストを受け取り、それを要約してポジティブなフィードバックを返すよう Cloudflare Workers AI に依頼する TypeScript のコード例を生成してください」と依頼し、AI による要約とアドバイス生成機能を実装する
  - `src/lib/ai/progressFeedback.ts` にフィードバック生成ロジックを追加
- [x] AI が生成した要約とアドバイスを、ユーザーへの返信として Discord に送信する機能を実装する
  - `src/lib/discord/api.ts` 経由で Discord スレッドへ投稿し、結果を `messages` テーブルへ保存
- [x] Discord スラッシュコマンド登録用のスクリプトを実装し、開発用ギルドに対してコマンドをデプロイする
  - [discord_slash_command_registration.md](research/discord_slash_command_registration.md)
- [ ] `wrangler deploy`コマンドで作成した bot を Cloudflare Workers にデプロイし、実際に Discord サーバー上で 20 分ごとに通知が来ること、返信が保存・要約されることを確認する
- [ ] プロジェクトのセットアップ方法、必要な環境変数、デプロイ手順をまとめた README.md を作成する
